# Stop Hook JSON 验证失败问题修复记录

## 问题描述

**错误信息**: `Stop hook error: JSON validation failed`

**发生时间**: 2026-01-20

**影响**: 每次任务完成时触发 Stop hook 都会报错

## 根本原因分析

### 问题根源

Stop hook 配置使用了 `prompt` 类型：

```json
{
  "type": "prompt",
  "prompt": "分析任务执行结果：\n\n如果任务涉及代码实现、问题解决或新功能开发，且有价值的经验可以记录，请简要说明是否需要调用 evolver 代理进行系统进化。如果只是简单查询或信息获取，则说明无需进化。"
}
```

### 技术细节

根据 [Claude Code 官方文档](https://code.claude.com/docs/en/hooks)：

**Stop hook 的 prompt 类型要求 LLM 返回特定格式的 JSON**：

```json
{
  "ok": true,           // 或 false，表示是否允许停止
  "reason": "说明"      // 当 ok 为 false 时必需
}
```

**问题**：
- LLM（Claude）一直返回自然语言文本
- 系统期望 JSON 格式
- 导致 JSON validation failed 错误

### 为什么会这样设计？

prompt 类型的 Stop hook 设计用于：
- 智能评估任务是否真正完成
- 可以阻止 Claude 过早停止（`ok: false`）
- 需要 LLM 做出结构化决策

## 解决方案

### 采用方案：改为 command 类型

```json
{
  "type": "command",
  "command": "echo '\n💡 任务完成提示：\n如果本次任务涉及代码实现、问题解决或新功能开发，且有价值的经验可以记录，\n可以考虑调用 evolver 代理进行系统进化。\n'",
  "timeout": 5
}
```

### 方案选择理由

1. **简单有效** - 不需要 JSON 响应，直接输出提示信息
2. **符合需求** - 原始设计意图是提示而非决策
3. **避免复杂性** - 不需要 LLM 每次都返回 JSON
4. **保持功能** - 仍然提醒用户考虑进化

### 其他可选方案

**方案 A：移除 Stop hook**
- 优点：最简单
- 缺点：失去提示功能

**方案 B：保留 prompt 类型，训练 LLM 返回 JSON**
- 优点：保留智能决策能力
- 缺点：增加复杂性，每次都需要返回 JSON

**方案 C：使用 SubagentStop 事件**
- 优点：只在子代理完成时触发
- 缺点：不适用于主任务

## 验证结果

✅ 修复后测试：
```bash
echo '
💡 任务完成提示：
如果本次任务涉及代码实现、问题解决或新功能开发，且有价值的经验可以记录，
可以考虑调用 evolver 代理进行系统进化。
'
```

输出正常，无 JSON 验证错误。

## 经验教训

### 关键洞察

1. **Hook 类型选择很重要**
   - `command` 类型：执行命令，返回文本
   - `prompt` 类型：LLM 评估，必须返回 JSON

2. **prompt 类型的正确使用场景**
   - 需要智能决策时（允许/阻止操作）
   - 必须返回 `{"ok": boolean, "reason": string}` 格式
   - 适合 PreToolUse 阻止危险操作

3. **Stop hook 的最佳实践**
   - 简单提示用 `command` 类型
   - 智能决策用 `prompt` 类型（需要 JSON 响应）
   - 考虑使用 SubagentStop 针对子代理

### 改进建议

1. **文档更新**
   - 在 CLAUDE.md 中添加 Hook 类型选择指南
   - 说明 prompt 类型的 JSON 响应要求

2. **错误处理**
   - 添加更详细的错误信息
   - 提供 JSON schema 验证失败的具体原因

3. **测试覆盖**
   - 在 test-hooks.sh 中添加 Stop hook 测试
   - 验证 prompt 类型的 JSON 响应

## 提交记录

**Commit**: `712d3b0`

**提交信息**:
```
fix(hooks): 修复 Stop hook JSON 验证失败问题

问题分析：
- Stop hook 使用 prompt 类型时，要求 LLM 返回特定格式的 JSON: {"ok": true/false, "reason": "..."}
- 之前配置导致 LLM 返回自然语言文本，触发 JSON validation failed 错误

解决方案：
- 将 Stop hook 从 prompt 类型改为 command 类型
- 使用 echo 命令输出简单的提示信息
- 添加 5 秒超时限制

参考文档：
- https://code.claude.com/docs/en/hooks

🤖 Generated by Claude Dev Team AI System
```

## 参考资料

- [Claude Code Hooks 官方文档](https://code.claude.com/docs/en/hooks)
- [Claude Code Hooks 实践指南](https://lakshminp.substack.com/p/claude-code-hooks-the-feature-youre)
- [.claude Directory - Hooks](https://dotclaude.com/hooks)

## 后续行动

- [ ] 更新 CLAUDE.md 添加 Hook 类型选择指南
- [ ] 在 test-hooks.sh 中添加 Stop hook 测试
- [ ] 考虑为其他 Hook 添加类似的文档
