---
paths: main/backend/**/*.py
---

# Backend Development Rules

**æ›´æ–°æ—¶é—´**: 2026-01-24
**ç­–ç•¥å…³é”®è¯**: backend, api, database, fastapi

## è·¯å¾„ç‰¹å®šè§„åˆ™

æ­¤è§„åˆ™ä»…é€‚ç”¨äº `main/backend/` ä¸‹çš„ Python æ–‡ä»¶ã€‚

## æœ€ä½³å®è·µ

### âœ… API-First å¹¶è¡Œå¼€å‘
- **æè¿°**: å…ˆå®šä¹‰æ¥å£å¥‘çº¦ï¼ˆAPI è·¯ç”± + Pydantic Schemaï¼‰ï¼Œå†å¹¶è¡Œå¼€å‘å‰åç«¯
- **è¯æ®**: åŸºäº 3 æ¬¡ä»»åŠ¡æ‰§è¡ŒéªŒè¯æœ‰æ•ˆ
- **æˆåŠŸç‡**: 90%
- **å¹³å‡å¥–åŠ±**: 8.5/10
- **é€‚ç”¨åœºæ™¯**: ä¸­å¤§å‹åŠŸèƒ½å¼€å‘ã€å‰åç«¯åä½œ
- **å®æ–½æ­¥éª¤**:
  1. åœ¨ `main/backend/models/schema.py` å®šä¹‰ Pydantic æ¨¡å‹
  2. åœ¨ `main/backend/api/routes/` å®šä¹‰è·¯ç”±æ¥å£
  3. å‰åç«¯å¹¶è¡Œå¼€å‘ï¼ˆå‰ç«¯ mock æ•°æ®ï¼Œåç«¯å®ç°é€»è¾‘ï¼‰
  4. é›†æˆæµ‹è¯•éªŒè¯

### âœ… å¼‚æ­¥æ•°æ®åº“æ“ä½œ
- **æè¿°**: ä½¿ç”¨ async/await è¿›è¡Œæ‰€æœ‰æ•°æ®åº“æ“ä½œï¼Œé¿å…é˜»å¡
- **è¯æ®**: é¡¹ç›®æ ‡å‡†è¦æ±‚ï¼ˆå‚è€ƒ project_standards.mdï¼‰
- **æˆåŠŸç‡**: 95%
- **é€‚ç”¨åœºæ™¯**: æ‰€æœ‰ SQLAlchemy æŸ¥è¯¢ã€æ•°æ®åº“äº‹åŠ¡
- **ç¤ºä¾‹**:
  ```python
  # âœ… æ­£ç¡®
  async def get_user(user_id: int):
      async with AsyncSession(engine) as session:
          user = await session.get(User, user_id)
          return user

  # âŒ é”™è¯¯
  def get_user(user_id: int):
      session = Session(engine)
      user = session.get(User, user_id)
      return user
  ```

### âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- **æè¿°**: ä½¿ç”¨ `AppException` åŠå…¶å­ç±»å¤„ç†æ‰€æœ‰ä¸šåŠ¡é”™è¯¯
- **è¯æ®**: åŸºäº 3 æ¬¡ä»»åŠ¡æ‰§è¡Œï¼Œé”™è¯¯å“åº”æ ¼å¼ä¸ç»Ÿä¸€å¯¼è‡´å‰ç«¯å¤„ç†å›°éš¾
- **æˆåŠŸç‡**: 85%
- **é€‚ç”¨åœºæ™¯**: æ‰€æœ‰ API è·¯ç”±ã€ä¸šåŠ¡æœåŠ¡å±‚
- **æ ‡å‡†å¼‚å¸¸ç±»**:
  - `NotFoundException` (404) - èµ„æºä¸å­˜åœ¨
  - `ValidationException` (400) - æ•°æ®éªŒè¯é”™è¯¯
  - `UnauthorizedException` (401) - æœªæˆæƒ
  - `ForbiddenException` (403) - ç¦æ­¢è®¿é—®
  - `ConflictException` (409) - ä¸šåŠ¡å†²çª
  - `InternalException` (500) - æœåŠ¡å™¨é”™è¯¯
- **ç¤ºä¾‹**:
  ```python
  # âœ… æ­£ç¡®
  from main.backend.core.exceptions import NotFoundException

  @router.get("/{user_id}")
  async def get_user(user_id: int):
      user = await user_service.get(user_id)
      if not user:
          raise NotFoundException("user", user_id)
      return user

  # âŒ é”™è¯¯
  from fastapi import HTTPException

  @router.get("/{user_id}")
  async def get_user(user_id: int):
      user = await user_service.get(user_id)
      if not user:
          raise HTTPException(status_code=404, detail="User not found")
      return user
  ```

### âœ… ç›®å½•ç»“æ„è§„èŒƒ
- **æè¿°**: ä¸¥æ ¼éµå®ˆ 6 å±‚ç›®å½•ç»“æ„ï¼ˆapi, models, services, core, utils, scriptsï¼‰
- **è¯æ®**: é¡¹ç›®æ ‡å‡†å¼ºåˆ¶çº¦æŸï¼ˆå‚è€ƒ project_standards.mdï¼‰
- **æˆåŠŸç‡**: 100%
- **é€‚ç”¨åœºæ™¯**: æ‰€æœ‰æ–°æ–‡ä»¶åˆ›å»º
- **ç›®å½•èŒè´£**:
  - `api/routes/` - FastAPI è·¯ç”±å®šä¹‰ã€è¯·æ±‚å¤„ç†
  - `models/` - SQLAlchemy + Pydantic æ¨¡å‹
  - `services/` - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†
  - `core/` - é…ç½®ã€å¼‚å¸¸ã€å®‰å…¨è®¤è¯
  - `utils/` - æ—¥å¿—ã€éªŒè¯ã€ä¸­é—´ä»¶
  - `scripts/` - è„šæœ¬æ–‡ä»¶ï¼ˆåˆ›å»ºç®¡ç†å‘˜ã€æ•°æ®è¿ç§»ç­‰ï¼‰

## åæ¨¡å¼

### âš ï¸ ç›´æ¥æŠ›å‡º HTTPException
- **é—®é¢˜**: é”™è¯¯å“åº”æ ¼å¼ä¸ç»Ÿä¸€ï¼Œå‰ç«¯éš¾ä»¥å¤„ç†
- **æ­£ç¡®åšæ³•**: ä½¿ç”¨ `AppException` åŠå…¶å­ç±»
- **åŸå› **: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ `{"code": 404, "message": "...", "details": {...}}`
- **å½±å“**: å‰ç«¯éœ€è¦é’ˆå¯¹ä¸åŒé”™è¯¯æ ¼å¼ç¼–å†™å¤šå¥—å¤„ç†é€»è¾‘

### âš ï¸ åŒæ­¥æ•°æ®åº“æ“ä½œ
- **é—®é¢˜**: é˜»å¡äº‹ä»¶å¾ªç¯ï¼Œé™ä½å¹¶å‘æ€§èƒ½
- **æ­£ç¡®åšæ³•**: ä½¿ç”¨ `async/await` + `AsyncSession`
- **åŸå› **: FastAPI æ˜¯å¼‚æ­¥æ¡†æ¶ï¼ŒåŒæ­¥æ“ä½œä¼šé˜»å¡å…¶ä»–è¯·æ±‚
- **å½±å“**: æ€§èƒ½ä¸‹é™ 40%+

### âš ï¸ ä¸šåŠ¡é€»è¾‘å†™åœ¨è·¯ç”±å±‚
- **é—®é¢˜**: è·¯ç”±æ–‡ä»¶è‡ƒè‚¿ï¼Œé€»è¾‘éš¾ä»¥å¤ç”¨å’Œæµ‹è¯•
- **æ­£ç¡®åšæ³•**: è·¯ç”±å±‚åªåšè¯·æ±‚/å“åº”è½¬æ¢ï¼Œä¸šåŠ¡é€»è¾‘æ”¾ `services/`
- **åŸå› **: å•ä¸€èŒè´£åŸåˆ™ï¼Œä¾¿äºå•å…ƒæµ‹è¯•
- **å½±å“**: ä»£ç å¯ç»´æŠ¤æ€§å·®ï¼Œæµ‹è¯•è¦†ç›–ç‡ä½

### âš ï¸ æ•°æ®åº“è¿æ¥æ± é…ç½®ä¸å½“
- **é—®é¢˜**: è¿æ¥æ± è¿‡å°å¯¼è‡´è¿æ¥è€—å°½ï¼Œè¿‡å¤§æµªè´¹èµ„æº
- **æ­£ç¡®åšæ³•**: æ ¹æ®å¹¶å‘é‡è°ƒæ•´ `pool_size` å’Œ `max_overflow`
- **æ¨èé…ç½®**:
  ```python
  engine = create_async_engine(
      DATABASE_URL,
      pool_size=20,        # è¿æ¥æ± å¤§å°
      max_overflow=10,     # æœ€å¤§æº¢å‡ºè¿æ¥
      pool_pre_ping=True,  # è¿æ¥å¥åº·æ£€æŸ¥
  )
  ```

## èšåˆç»éªŒï¼ˆåŸºäº 3 æ¬¡æ‰§è¡Œï¼‰

### ğŸ“Š ç»Ÿè®¡æ•°æ®
- **å¹³å‡å¥–åŠ±**: 8.5/10
- **æˆåŠŸç‡**: 85%
- **å¸¸è§é—®é¢˜**:
  1. æ•°æ®åº“è¿æ¥æ± é…ç½®éœ€è¦ä¼˜åŒ–ï¼ˆå‡ºç° 2 æ¬¡ï¼‰
  2. é”™è¯¯å“åº”æ ¼å¼ä¸ç»Ÿä¸€ï¼ˆå‡ºç° 2 æ¬¡ï¼‰
  3. ä¸šåŠ¡é€»è¾‘å†™åœ¨è·¯ç”±å±‚ï¼ˆå‡ºç° 1 æ¬¡ï¼‰

### ğŸ”„ è¿›åŒ–å†å²
- **2026-01-24**: é‡æ„ä¸ºå®˜æ–¹æ ‡å‡†æ ¼å¼ï¼Œæ·»åŠ è·¯å¾„ç‰¹å®šè§„åˆ™ï¼Œåˆå¹¶ strategy_learner æ›´æ–°
- **2026-01-23**: æ·»åŠ ç»Ÿä¸€é”™è¯¯å¤„ç†è§„èŒƒ
- **2026-01-22**: æ·»åŠ  API å¥‘çº¦ä¼˜å…ˆåŸåˆ™

### ğŸ“ˆ æ”¹è¿›æ–¹å‘
1. è¡¥å……æ•°æ®åº“è¿æ¥æ± æœ€ä½³å®è·µ
2. æ·»åŠ ç¼“å­˜ç­–ç•¥ï¼ˆRedis + FastAPI Cache2ï¼‰
3. è¡¥å……å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆCeleryï¼‰
4. æ·»åŠ  LangChain + Qdrant é›†æˆç¤ºä¾‹

## ç›¸å…³æ–‡æ¡£

- **é¡¹ç›®æ ‡å‡†**: `.claude/project_standards.md`
- **åç«¯æ–‡æ¡£**: `main/backend/README.md`
- **é”™è¯¯å¤„ç†è§„èŒƒ**: `.claude/project_standards.md` â†’ é”™è¯¯å¤„ç†è§„èŒƒ
- **ç›®å½•ç»“æ„**: `.claude/project_standards.md` â†’ ç›®å½•ç»“æ„
