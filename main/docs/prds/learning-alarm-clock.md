# 产品需求文档：学习闹钟功能

## 1. 概述

### 问题陈述
小学生在使用 KET 备考系统时，容易长时间连续学习导致疲劳，影响学习效果和身体健康。需要一个自动化的学习时间管理机制，强制学生劳逸结合。

### 解决方案描述
开发一个学习闹钟功能，自动监控学生的学习时长，在达到设定时间后强制休息，确保学生有规律的学习节奏。管理员可以灵活配置全局规则或针对特定学生的个性化规则。

### 成功指标
- 学习时长控制准确率 100%
- 休息时间强制执行成功率 100%
- 管理员配置操作便捷性评分 ≥ 4.5/5
- 系统性能影响 < 5%

## 2. 用户故事

### 学生端
- **US-1**: 作为学生，我想在开始学习时自动启动计时，以便系统能够监控我的学习时长
- **US-2**: 作为学生，我想看到清晰的倒计时显示，以便知道还能学习多久
- **US-3**: 作为学生，我想在学习时间到达后被强制休息，以便保护我的健康
- **US-4**: 作为学生，我想在休息时间看到倒计时，以便知道何时可以继续学习
- **US-5**: 作为学生，我不能通过刷新页面绕过休息限制，以便确保休息时间

### 管理员端
- **US-6**: 作为管理员，我想设置全局学习时长和休息时长，以便统一管理所有学生
- **US-7**: 作为管理员，我想为特定学生设置个性化规则，以便满足不同学生的需求
- **US-8**: 作为管理员，我想查看当前生效的规则列表，以便了解系统配置
- **US-9**: 作为管理员，我想修改或删除已有规则，以便灵活调整策略

## 3. 功能需求

### 3.1 学生端功能

#### F-1: 自动计时启动
- 学生首次答题时自动启动学习计时
- 计时状态持久化到数据库
- 页面刷新后计时状态不丢失

#### F-2: 倒计时显示
- 页面顶部显示学习倒计时（格式：MM:SS）
- 倒计时每秒更新
- 倒计时接近结束时（最后 5 分钟）显示警告颜色

#### F-3: 学习时间限制
- 学习时间到达后，禁用所有学习功能：
  - 禁用答题按钮
  - 禁用获取新题目按钮
  - 禁用查看进度功能
- 显示强制休息提示信息
- 自动切换到休息模式

#### F-4: 强制休息模式
- 显示休息倒计时（格式：MM:SS）
- 显示休息提示信息和建议活动
- 休息时间结束后自动恢复学习功能
- 休息期间尝试操作时显示友好提示

#### F-5: 防绕过机制
- 计时状态存储在服务器端
- 前端每次操作都验证服务器端状态
- 刷新页面后自动恢复正确的计时状态
- 修改本地时间无法绕过限制

### 3.2 管理员端功能

#### F-6: 规则配置界面
- 提供独立的闹钟规则管理页面
- 支持创建、编辑、删除规则
- 支持启用/禁用规则

#### F-7: 全局规则设置
- 设置默认学习时长（分钟）
- 设置默认休息时长（分钟）
- 全局规则应用到所有未设置个性化规则的学生

#### F-8: 个性化规则设置
- 根据学生昵称设置个性化规则
- 个性化规则优先级高于全局规则
- 支持为多个学生设置不同规则

#### F-9: 规则列表查看
- 显示所有规则列表（全局 + 个性化）
- 显示规则状态（启用/禁用）
- 显示规则创建时间和最后修改时间

## 4. 非功能需求

### 4.1 性能要求
- 倒计时更新延迟 < 100ms
- API 响应时间 < 200ms
- 数据库查询优化，避免频繁查询

### 4.2 安全要求
- 计时状态必须在服务器端验证
- 防止客户端篡改计时数据
- 管理员操作需要权限验证

### 4.3 可用性要求
- 倒计时显示清晰易读
- 休息提示信息友好温馨
- 管理员配置界面简洁直观

### 4.4 可靠性要求
- 计时状态持久化，防止数据丢失
- 系统重启后状态自动恢复
- 异常情况下优雅降级

### 4.5 兼容性要求
- 支持主流浏览器（Chrome、Firefox、Safari、Edge）
- 支持移动端浏览器
- 支持不同屏幕尺寸

## 5. 验收标准

### 学生端
- [ ] 学生开始答题时自动启动计时
- [ ] 页面顶部显示清晰的倒计时
- [ ] 学习时间到达后所有学习功能被禁用
- [ ] 强制休息期间显示休息倒计时
- [ ] 休息时间结束后自动恢复学习功能
- [ ] 刷新页面后计时状态正确恢复
- [ ] 修改本地时间无法绕过限制

### 管理员端
- [ ] 管理员可以设置全局规则
- [ ] 管理员可以为特定学生设置个性化规则
- [ ] 管理员可以查看所有规则列表
- [ ] 管理员可以编辑和删除规则
- [ ] 管理员可以启用/禁用规则

### 技术验收
- [ ] 所有 API 响应时间 < 200ms
- [ ] 倒计时更新流畅无卡顿
- [ ] 数据库查询优化，无 N+1 问题
- [ ] 代码覆盖率 ≥ 80%
- [ ] 无安全漏洞

## 6. 技术考虑

### 6.1 数据库设计

#### 新增表：alarm_rules（闹钟规则表）
```sql
CREATE TABLE alarm_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_type TEXT NOT NULL,  -- 'global' 或 'personal'
    student_nickname TEXT,     -- 个性化规则时填写，全局规则为 NULL
    study_duration INTEGER NOT NULL,  -- 学习时长（分钟）
    rest_duration INTEGER NOT NULL,   -- 休息时长（分钟）
    is_active BOOLEAN DEFAULT TRUE,   -- 是否启用
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 新增表：alarm_sessions（学习会话表）
```sql
CREATE TABLE alarm_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    session_type TEXT NOT NULL,  -- 'studying' 或 'resting'
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    rule_id INTEGER,  -- 关联的规则 ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (rule_id) REFERENCES alarm_rules(id)
);
```

### 6.2 API 端点需求

#### 学生端 API
- `GET /api/v1/alarm/status` - 获取当前学习状态
- `POST /api/v1/alarm/start` - 开始学习（首次答题时调用）
- `GET /api/v1/alarm/validate` - 验证是否可以操作（每次操作前调用）

#### 管理员端 API
- `GET /api/v1/alarm/rules` - 获取所有规则
- `POST /api/v1/alarm/rules` - 创建规则
- `PUT /api/v1/alarm/rules/{id}` - 更新规则
- `DELETE /api/v1/alarm/rules/{id}` - 删除规则
- `PATCH /api/v1/alarm/rules/{id}/toggle` - 启用/禁用规则

### 6.3 前端状态管理
- 使用 Pinia 管理闹钟状态
- 使用 setInterval 实现倒计时
- 使用 localStorage 缓存状态（辅助，以服务器为准）

### 6.4 技术风险
- **风险 1**: 客户端时间不准确
  - **缓解**: 使用服务器时间计算，客户端只负责显示
- **风险 2**: 频繁的状态验证影响性能
  - **缓解**: 使用缓存机制，减少数据库查询
- **风险 3**: 用户通过多个设备绕过限制
  - **缓解**: 基于用户 ID 而非设备进行限制

## 7. 实现优先级

### P0（必须实现）
- 学生端自动计时和倒计时显示
- 学习时间到达后强制休息
- 管理员设置全局规则

### P1（重要）
- 管理员设置个性化规则
- 防刷新绕过机制
- 规则列表查看和管理

### P2（可选）
- 休息时间建议活动提示
- 学习统计报表
- 规则生效时间段设置

## 8. 时间估算

- 数据库设计和迁移：2 小时
- 后端 API 开发：4 小时
- 前端界面开发：4 小时
- 集成测试：2 小时
- Bug 修复和优化：2 小时

**总计：14 小时（约 2 个工作日）**

## 9. 附录

### 9.1 倒计时显示示例
```
正常状态：学习时间剩余 25:30
警告状态：学习时间剩余 04:45 ⚠️
休息状态：休息时间剩余 08:20 😊
```

### 9.2 休息提示信息示例
```
学习时间到啦！该休息一下了 😊

建议活动：
- 站起来走动走动
- 做做眼保健操
- 喝杯水
- 看看窗外的风景

休息时间剩余：09:45
```

### 9.3 管理员配置界面示例
```
闹钟规则管理

全局规则：
- 学习时长：30 分钟
- 休息时长：10 分钟
- 状态：启用

个性化规则：
| 学生昵称 | 学习时长 | 休息时长 | 状态 | 操作 |
|---------|---------|---------|------|------|
| 小明    | 45 分钟 | 15 分钟 | 启用 | 编辑 删除 |
| 小红    | 20 分钟 | 5 分钟  | 禁用 | 编辑 删除 |
```
